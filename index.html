<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rutas Verdes</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.icono-rotatorio {
  transform-origin: center center;
}

.flecha-usuario {
  width: 40px;
  height: 40px;
  background-image: url('https://www.pngarts.com/files/13/Caret-Arrow-PNG-Photo.png'); /* üîπ Imagen de flecha */
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  transform: rotate(); /* üîπ Ajuste para que apunte al norte por defecto */
  transition: transform 0.2s linear;
}

  body {
    background-color: #000;
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    color: white;
    text-align: center;
  }

  #mapa {
    height: 100vh;
    width: 100%;
  }

  /* ‚úÖ Botones principales */
  .btn {
    display: block;
    width: 80%;
    margin: 10px auto;
    padding: 15px;
    background: linear-gradient(135deg, #009900, #00cc44);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  }

  .btn:hover {
    background: linear-gradient(135deg, #00b33c, #00ff66);
    transform: scale(1.03);
  }

  /* ‚úÖ Contenedor inferior */
  .inferior {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: rgba(20, 20, 20, 0.95);
    backdrop-filter: blur(6px);
    padding: 15px 10px 10px;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.5);
    border-top: 1px solid #004d00;
    z-index: 1000;
  }

  .inferior .btn {
    display: inline-block;
    width: 45%;
    margin: 5px 2%;
    font-size: 1.1em;
  }

  /* ‚úÖ Firma */
  .firma {
    position: fixed;
    bottom: 90px;
    left: 20px;
    font-size: 0.85em;
    color: #aaa;
    font-style: italic;
    z-index: 1001;
    opacity: 0.8;
  }

  /* ‚úÖ Men√∫ de rutas */
  .menu {
    position: absolute;
    top: 15px;
    left: 1000px;
    background: rgba(255,255,255,0.9);
    padding: 10px 15px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 1000;
    font-family: sans-serif;
  }

  .menu label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #000;
  }
  .color-cuadro {
  width: 15px;
  height: 15px;
  border-radius: 3px;
  display: inline-block;
}

/* üîπ Colores de cada ruta */
.verde { background-color: #28a745; }
.naranja { background-color: #ff9800; }
.azul { background-color: #007bff; }
.rojo { background-color: #dc3545; }

  /* üîπ Bot√≥n hamburguesa (solo m√≥vil) */
  .toggle-menu {
    position: fixed;
    top: 15px;
    right: 15px;
    background: rgba(0, 153, 0, 0.9);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 20px;
    cursor: pointer;
    z-index: 1100;
    display: none;
  }

  /* üîπ Adaptaci√≥n para m√≥viles */
  @media (max-width: 768px) {
    .menu {
      left: 0;
      right: 0;
      top: 0;
      border-radius: 0 0 12px 12px;
      padding: 12px;
      display: none;
    }

    .menu.activo {
      display: block;
    }

    .toggle-menu {
      display: block;
    }

    .inferior .btn {
      width: 48%;
      font-size: 0.95em;
      padding: 12px;
    }

    .firma {
      font-size: 0.75em;
      left: 10px;
    }
  }

</style>
</head>
<body>
  <div id="mapa"></div>
    <button class="toggle-menu" onclick="document.querySelector('.menu').classList.toggle('activo')">
  ‚ò∞
    </button>

  <!-- ‚úÖ Men√∫ para ocultar/mostrar rutas -->
<div class="menu">
  <label><input type="checkbox" id="a_ida" checked> Ruta A - Ida   <span class="color-cuadro verde"></span></label>
  <label><input type="checkbox" id="a_retorno" checked> Ruta A - Retorno   <span class="color-cuadro naranja"></span></label>
  <label><input type="checkbox" id="b_ida" checked> Ruta B - Ida   <span class="color-cuadro azul"></span></label>
  <label><input type="checkbox" id="b_retorno" checked> Ruta B - Retorno   <span class="color-cuadro rojo"></span></label>
</div>

  <!-- ‚úÖ Botones inferiores -->
  <div class="inferior">
    <button id="btnUbicacion" class="btn">¬øD√≥nde est√°s?</button>
    <button id="btnDestino" class="btn">¬øHacia d√≥nde?</button>
  </div>

  <!-- ‚úÖ Firma -->
  <div class="firma">@uni_dev</div>

<script>
  const mapa = L.map('mapa').setView([9.3047, -75.3978], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(mapa);

  // ---- RUTAS ----
  let rutaA_ida, rutaA_retorno, rutaB_ida, rutaB_retorno;

  // Ruta A ida
  fetch('a_ida.json')
    .then(res => res.json())
    .then(data => {
      rutaA_ida = L.geoJSON(data, {
        filter: (f) => f.geometry.type === "LineString",
        style: { color: 'green', weight: 5, opacity: 0.7}
      }).addTo(mapa);
    });

  // Ruta A retorno
  fetch('a_retorno.json')
    .then(res => res.json())
    .then(data => {
      rutaA_retorno = L.geoJSON(data, {
        filter: (f) => f.geometry.type === "LineString",
        style: { color: 'orange', weight: 4, opacity: 0.8, dashArray: '6 6' }
      }).addTo(mapa);
    });

  // Ruta B ida
  fetch('b_ida.json')
    .then(res => res.json())
    .then(data => {
      rutaB_ida = L.geoJSON(data, {
        filter: (f) => f.geometry.type === "LineString",
        style: { color: 'blue', weight: 5, opacity: 0.5}
      }).addTo(mapa);
    });

     // Ruta B retorno
  fetch('b_retorno.json')
    .then(res => res.json())
    .then(data => {
      rutaB_retorno = L.geoJSON(data, {
        filter: (f) => f.geometry.type === "LineString",
        style: { color: 'red', weight: 5, opacity: 0.5, dashArray: '9 9' }
      }).addTo(mapa);
    }); 

  // ---- Control de visibilidad ----
  function toggleRuta(checkboxId, layer) {
    const checkbox = document.getElementById(checkboxId);
    checkbox.addEventListener('change', () => {
      if (!layer) return;
      if (checkbox.checked) layer.addTo(mapa);
      else mapa.removeLayer(layer);
    });
  }

  // Esperar un poco para que las rutas se carguen antes de aplicar eventos
  setTimeout(() => {
    toggleRuta('a_ida', rutaA_ida);
    toggleRuta('a_retorno', rutaA_retorno);
    toggleRuta('b_ida', rutaB_ida);
    toggleRuta('b_retorno', rutaB_retorno);
  }, 1000);

 let marcadorUsuario = null;
  const botonUbicacion = document.getElementById('btnUbicacion');
 let coordenadasUsuario = { lat: null, lon: null };
 
// --- Obtener direcci√≥n desde coordenadas (solo barrio y direcci√≥n) ---
async function obtenerDireccion(lat, lon) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`);
    const data = await res.json();
    const addr = data.address;
    const barrio = addr.suburb || addr.neighbourhood || addr.village || addr.town || "";
    const calle = addr.road || addr.residential || addr.pedestrian || "";
    const numero = addr.house_number ? ` #${addr.house_number}` : "";
    const texto = [barrio, `${calle}${numero}`].filter(Boolean).join(", ");
    return texto || "Ubicaci√≥n desconocida";
  } catch {
    return "No se pudo obtener la direcci√≥n";
  }
}


  // --- Mostrar ubicaci√≥n en mapa ---
  async function mostrarUbicacion(lat, lon) {
    const direccion = await obtenerDireccion(lat, lon);
    // Si ya hay un marcador, actualizar posici√≥n en lugar de eliminar y crear
    if (!marcadorUsuario) {
      marcadorUsuario = L.marker([lat, lon], { draggable: true }).addTo(mapa);
    } else {
      marcadorUsuario.setLatLng([lat, lon]);
    }

    marcadorUsuario.bindPopup(`üìç ${direccion}`).openPopup();
    mapa.setView([lat, lon], 15);

    botonUbicacion.innerText = `üìç ${direccion}`;

    // Eliminar eventos previos y volver a asignar
    marcadorUsuario.off('dragend');
    marcadorUsuario.on('dragend', async (e) => {
      const pos = e.target.getLatLng();
      const nuevaDir = await obtenerDireccion(pos.lat, pos.lng);
      marcadorUsuario.setPopupContent(`${nuevaDir} üìç`).openPopup();
      botonUbicacion.innerText = `${nuevaDir} üìç`;
    });
    coordenadasUsuario = { lat, lon }; // Guardar coordenadas actuales
  }

  // --- Intentar detectar ubicaci√≥n autom√°ticamente al inicio ---
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => mostrarUbicacion(pos.coords.latitude, pos.coords.longitude),
      () => {
        botonUbicacion.innerText = "Pulsa para detectar ubicaci√≥n üìç";
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  } else {
    botonUbicacion.innerText = "Tu navegador no soporta GPS";
  }

  // --- Bot√≥n: siempre repite detecci√≥n al presionarse ---
  botonUbicacion.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Tu navegador no soporta geolocalizaci√≥n.');
      return;
    }

    botonUbicacion.innerText = 'üì° Detectando ubicaci√≥n...';

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        await mostrarUbicacion(pos.coords.latitude, pos.coords.longitude);
        botonUbicacion.innerText = 'Actualizado...';
        setTimeout(() => botonUbicacion.innerText = '¬øD√≥nde est√°s?', 3000);
      },
      () => {
        botonUbicacion.innerText = 'No se pudo detectar ubicaci√≥n üìç, toca el mapa.';
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
// === FLECHA DE DIRECCI√ìN EN TIEMPO REAL (solo m√≥vil) ===
const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
let flechaDireccion = null;
let ultimoAngulo = 0;

if (esMovil && navigator.geolocation) {
  // --- Crear el icono con tu estilo ---
  const iconoFlecha = L.divIcon({
    className: 'icono-rotatorio',
    iconSize: [40, 40],
    iconAnchor: [20, 20],
    html: '<div class="flecha-usuario"></div>'
  });

  // --- Rastreo continuo de posici√≥n ---
  navigator.geolocation.watchPosition(
    (pos) => {
      const { latitude: lat, longitude: lon } = pos.coords;

      if (!flechaDireccion) {
        flechaDireccion = L.marker([lat, lon], { icon: iconoFlecha, interactive: false }).addTo(mapa);
      } else {
        flechaDireccion.setLatLng([lat, lon]);
      }
    },
    (err) => console.warn("Error de GPS:", err),
    { enableHighAccuracy: true, maximumAge: 1000 }
  );

  // --- Orientaci√≥n de la flecha (br√∫jula en tiempo real) ---
  if (window.DeviceOrientationEvent) {
    window.addEventListener("deviceorientationabsolute", (event) => {
      const heading = event.alpha;
      if (heading == null || !flechaDireccion || !flechaDireccion._icon) return;

      const rotacion = 360 - heading;
      if (Math.abs(rotacion - ultimoAngulo) > 1) {
        ultimoAngulo = rotacion;
        flechaDireccion._icon.firstChild.style.transform = `rotate(${rotacion}deg)`;
      }
    });
  }
}
// --- Variables globales ---
let marcadorDestino = null;
let destinoSeleccionado = false;
let modoSeleccionDestino = false;
let coordenadasDestino = null;

// --- Bot√≥n "¬øHacia d√≥nde?" ---
const botonDestino = document.getElementById("btnDestino");

// --- √çcono del destino ---
const iconoDestino = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize: [38, 38],
  iconAnchor: [19, 38],
  popupAnchor: [0, -38]
});

// --- Al presionar el bot√≥n ---
botonDestino.addEventListener("click", () => {
  if (destinoSeleccionado) {
    // Si ya hay un destino seleccionado ‚Üí eliminar y reiniciar
    mapa.removeLayer(marcadorDestino);
    marcadorDestino = null;
    coordenadasDestino = null;
    destinoSeleccionado = false;
    botonDestino.textContent = "¬øHacia d√≥nde?";
    return;
  }

  // Activar modo selecci√≥n
  modoSeleccionDestino = true;
  botonDestino.textContent = "üìç Seleccione un lugar en el mapa...";
});

// --- Evento para seleccionar el destino con un clic ---
mapa.on("click", async (e) => {
  if (!modoSeleccionDestino) return;

  const { lat, lng } = e.latlng;
  coordenadasDestino = { lat, lng };

  // Eliminar marcador anterior si existe
  if (marcadorDestino) mapa.removeLayer(marcadorDestino);

  // Crear marcador nuevo
  marcadorDestino = L.marker([lat, lng], { icon: iconoDestino }).addTo(mapa);

  // Obtener direcci√≥n con Nominatim
try {
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
  const data = await res.json();
  const addr = data.address;
  const barrio = addr.suburb || addr.neighbourhood || addr.village || addr.town || "";
  const calle = addr.road || addr.residential || addr.pedestrian || "";
  const numero = addr.house_number ? ` #${addr.house_number}` : "";
  const direccion = [barrio, `${calle}${numero}`].filter(Boolean).join(", ") || "Destino sin direcci√≥n";

  marcadorDestino.bindPopup(`<b>Destino:</b><br>${direccion} üìç`).openPopup();
  botonDestino.textContent = direccion + " üìç";
} catch {
  botonDestino.textContent = "Destino seleccionado üìç";
}


  // Centrar el mapa y desactivar modo selecci√≥n
  mapa.flyTo([lat, lng], 16);
  modoSeleccionDestino = false;
  destinoSeleccionado = true;
});

</script>
</body>
</button>
</html>
