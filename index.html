<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rutas Verdes</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body {
    background-color: #000;
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    color: white;
    text-align: center;
  }

  #mapa {
    height: 100vh;
    width: 100%;
  }

  /* ‚úÖ Botones principales */
  .btn {
    display: block;
    width: 80%;
    margin: 10px auto;
    padding: 15px;
    background: linear-gradient(135deg, #009900, #00cc44);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  }

  .btn:hover {
    background: linear-gradient(135deg, #00b33c, #00ff66);
    transform: scale(1.03);
  }

  /* ‚úÖ Contenedor inferior */
  .inferior {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: rgba(20, 20, 20, 0.95);
    backdrop-filter: blur(6px);
    padding: 15px 10px 10px;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.5);
    border-top: 1px solid #004d00;
    z-index: 1000;
  }

  .inferior .btn {
    display: inline-block;
    width: 45%;
    margin: 5px 2%;
    font-size: 1.1em;
  }

  /* ‚úÖ Firma */
  .firma {
    position: fixed;
    bottom: 90px;
    left: 20px;
    font-size: 0.85em;
    color: #aaa;
    font-style: italic;
    z-index: 1001;
    opacity: 0.8;
  }

  /* ‚úÖ Men√∫ de rutas */
  .menu {
    position: absolute;
    top: 15px;
    left: 1150px;
    background: rgba(255,255,255,0.9);
    padding: 10px 15px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 1000;
    font-family: sans-serif;
  }

  .menu label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #000;
  }
</style>
</head>
<body>

  <div id="mapa"></div>

  <!-- ‚úÖ Men√∫ para ocultar/mostrar rutas -->
  <div class="menu">
    <label><input type="checkbox" id="a_ida" checked> Ruta A - Ida</label>
    <label><input type="checkbox" id="a_retorno" checked> Ruta A - Retorno</label>
    <label><input type="checkbox" id="b_ida" checked> Ruta B - Ida</label>
  </div>

  <!-- ‚úÖ Botones inferiores -->
  <div class="inferior">
    <button id="btnUbicacion" class="btn">¬øD√≥nde est√°s?</button>
    <button id="btnDestino" class="btn">¬øHacia d√≥nde?</button>
  </div>

  <!-- ‚úÖ Firma -->
  <div class="firma">@uni_dev</div>

<script>
  const mapa = L.map('mapa').setView([9.3047, -75.3978], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(mapa);

  // ---- RUTAS ----
  let rutaA_ida, rutaA_retorno, rutaB_ida;

  // Ruta A ida
  fetch('a_ida.json')
    .then(res => res.json())
    .then(data => {
      rutaA_ida = L.geoJSON(data, {
        filter: (f) => f.geometry.type === "LineString",
        style: { color: 'green', weight: 5, opacity: 0.7, dashArray: '6 6' }
      }).addTo(mapa);
    });

  // Ruta A retorno
  fetch('a_retorno.json')
    .then(res => res.json())
    .then(data => {
      rutaA_retorno = L.geoJSON(data, {
        filter: (f) => f.geometry.type === "LineString",
        style: { color: 'orange', weight: 4, opacity: 0.8, dashArray: '6 6' }
      }).addTo(mapa);
    });

  // Ruta B ida
  fetch('b_ida.json')
    .then(res => res.json())
    .then(data => {
      rutaB_ida = L.geoJSON(data, {
        filter: (f) => f.geometry.type === "LineString",
        style: { color: 'blue', weight: 5, opacity: 0.5, dashArray: '9 9' }
      }).addTo(mapa);
    });

  // ---- Control de visibilidad ----
  function toggleRuta(checkboxId, layer) {
    const checkbox = document.getElementById(checkboxId);
    checkbox.addEventListener('change', () => {
      if (!layer) return;
      if (checkbox.checked) layer.addTo(mapa);
      else mapa.removeLayer(layer);
    });
  }

  // Esperar un poco para que las rutas se carguen antes de aplicar eventos
  setTimeout(() => {
    toggleRuta('a_ida', rutaA_ida);
    toggleRuta('a_retorno', rutaA_retorno);
    toggleRuta('b_ida', rutaB_ida);
  }, 1000);

 let marcadorUsuario = null;
  const botonUbicacion = document.getElementById('btnUbicacion');

  // --- Obtener direcci√≥n desde coordenadas ---
  async function obtenerDireccion(lat, lon) {
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
      const data = await res.json();
      return data.display_name || "Ubicaci√≥n desconocida";
    } catch {
      return "No se pudo obtener la direcci√≥n";
    }
  }

  // --- Mostrar ubicaci√≥n en mapa ---
  async function mostrarUbicacion(lat, lon) {
    const direccion = await obtenerDireccion(lat, lon);

    // Si ya hay un marcador, actualizar posici√≥n en lugar de eliminar y crear
    if (!marcadorUsuario) {
      marcadorUsuario = L.marker([lat, lon], { draggable: true }).addTo(mapa);
    } else {
      marcadorUsuario.setLatLng([lat, lon]);
    }

    marcadorUsuario.bindPopup(`üìç ${direccion}`).openPopup();
    mapa.setView([lat, lon], 15);

    botonUbicacion.innerText = `üìç ${direccion}`;

    // Eliminar eventos previos y volver a asignar
    marcadorUsuario.off('dragend');
    marcadorUsuario.on('dragend', async (e) => {
      const pos = e.target.getLatLng();
      const nuevaDir = await obtenerDireccion(pos.lat, pos.lng);
      marcadorUsuario.setPopupContent(`üìç ${nuevaDir}`).openPopup();
      botonUbicacion.innerText = `üìç ${nuevaDir}`;
    });
  }

  // --- Intentar detectar ubicaci√≥n autom√°ticamente al inicio ---
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => mostrarUbicacion(pos.coords.latitude, pos.coords.longitude),
      () => {
        botonUbicacion.innerText = "Pulsa para detectar ubicaci√≥n üìç";
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  } else {
    botonUbicacion.innerText = "Tu navegador no soporta GPS";
  }

  // --- Clic en el mapa: usuario elige manualmente ---
  mapa.on('click', (e) => {
    mostrarUbicacion(e.latlng.lat, e.latlng.lng);
  });

  // --- Bot√≥n: siempre repite detecci√≥n al presionarse ---
  botonUbicacion.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Tu navegador no soporta geolocalizaci√≥n.');
      return;
    }

    botonUbicacion.innerText = 'üì° Detectando ubicaci√≥n...';

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        await mostrarUbicacion(pos.coords.latitude, pos.coords.longitude);
        botonUbicacion.innerText = 'üìç Actualizado';
        setTimeout(() => botonUbicacion.innerText = '¬øD√≥nde est√°s?', 3000);
      },
      () => {
        botonUbicacion.innerText = 'üìç No se pudo detectar ubicaci√≥n, toca el mapa.';
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
</script>

</body>
</html>
